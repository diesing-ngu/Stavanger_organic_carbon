---
title: "Data preparation"
output: html_notebook
---

# Preparations

## Install packages

```{r packages, message=FALSE, warning=FALSE}
if(!require("pacman")) install.packages("pacman"); library(pacman)
p_load(here, 
       sf,
       spatialEco,
       dplyr,
       terra,
       stars
       )
```


## Define projection and resolution

```{r projection}
crs <- "EPSG:25832"
res <- 50
```


## Define Area of Interest (AoI)

```{r aoi}
AoI <- read_sf(here("input_data", "depositional_areas.shp"))
```


# Predictor variables

Potentially relevant predictor variables are loaded and a raster stack is created.

```{r load_predictors}
predictors <- rast(here("input_data", "predictors.tif"))
```


## Ensure uniform projection

Check if AoI and predictors have the defined projection. Re-project if this is not the case.

```{r uniform_proj}
if (st_crs(AoI) != crs) {
  AoI <- st_transform(AoI, crs)
}

if (crs(predictors) != crs) {
  predictors <- project(x = predictors, y = crs, res = res)
}
```


## Crop predictors to AoI

```{r crop_predictors}
predictors <- crop(mask(predictors, AoI, touches = FALSE), AoI)
plot(predictors)
```


## Create a fishnet based on predictor raster

```{r fishnet}
min_ext <- sum(predictors)
min_ext[min_ext == 0] <- NA
fishnet <- st_as_sf(stars::st_as_stars(min_ext), as_points = FALSE, merge = FALSE)
fishnet$ID <- 1:nrow(fishnet)
```


# Response variable

## Load response data

```{r load_response}
resp_data <- read.csv(here("input_data", "data_matrix_bulk_samples_0-10cm.csv"), header = TRUE, sep = ",")
summary(resp_data)
```


## Convert to sf

```{r}
resp <- st_as_sf(resp_data, coords = c("Long_E", "Lat_N"), crs = "EPSG:4326")
summary(resp)
```


## Ensure uniform projection

Check if the response variable has the defined projection. Re-project if this is not the case.

```{r uniform_proj_oc}
if (st_crs(resp)$proj4string != crs) {
  resp <- st_transform(resp, crs)
}
```


## Centroids

Centroids are calculated to average all measurements within one grid cell.

```{r centroids_surface}
resp_centroids <- st_join(fishnet, resp)
resp_centroids <- na.omit(resp_centroids)
resp_centroids <- resp_centroids %>% group_by(ID) %>% summarize(CRI = mean(CRI, na.rm = TRUE))
resp <- st_centroid(resp_centroids)
```


## Create a regression matrix

```{r regression_matrix}
rm_resp <- as.data.frame(terra::extract(predictors, resp, bind = TRUE))
rm_resp <- rm_resp[-1] #removes first column (ID)
rm_resp <- na.omit(rm_resp) #removes rows with NAs
```


# Save files for later use

```{r save_files}
write_sf(AoI, here("cri", "data", "interim", "AoI.shp"))
writeRaster(predictors, here("cri","data", "interim", "predictors_aoi.tif"), overwrite = TRUE)
write_sf(resp, dsn = here("cri","data", "interim"), layer = "resp", driver = "ESRI Shapefile")
write.csv(rm_resp, here("cri","data", "interim", "rm_resp.csv"), quote = FALSE, row.names = FALSE)
```


